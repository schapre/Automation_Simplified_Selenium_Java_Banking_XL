name: CI/CD Pipeline - Automation Framework

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      test_suite:
        description: "Test suite to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - web
          - api
          - mobile
      environment:
        description: "Environment to test against"
        required: false
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      browser:
        description: "Browser for web tests"
        required: false
        default: "chrome"
        type: choice
        options:
          - chrome
          - firefox
          - edge

env:
  MAVEN_OPTS: "-Xmx2048m"
  JAVA_VERSION: "11"

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome, firefox]
        test-suite: [web, api]
      fail-fast: false
      max-parallel: 2

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Setup Chrome Browser
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Setup Firefox Browser
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@v1
        with:
          firefox-version: latest

      - name: Create test directories
        run: |
          mkdir -p test-output/videos
          mkdir -p target/allure-results
          mkdir -p target/surefire-reports

      - name: Verify Maven Installation
        run: mvn --version

      - name: Compile Project
        run: mvn clean compile test-compile

      - name: Run Tests
        env:
          BROWSER: ${{ matrix.browser }}
          TEST_SUITE: ${{ matrix.test-suite }}
          HEADLESS: true
          VIDEO_RECORDING_ENABLED: true
        run: |
          if [ "${{ github.event.inputs.test_suite }}" != "" ]; then
            TEST_SUITE="${{ github.event.inputs.test_suite }}"
          fi

          if [ "$TEST_SUITE" == "all" ]; then
            mvn test -Dbrowser=$BROWSER -Dheadless=true
          else
            mvn test -Dbrowser=$BROWSER -Dheadless=true -Dtags="@$TEST_SUITE"
          fi
        continue-on-error: true

      - name: Generate Allure Report
        if: always()
        run: |
          mvn allure:report

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.browser }}-${{ matrix.test-suite }}
          path: |
            target/surefire-reports/
            target/allure-results/
            target/allure-report/
            test-output/
          retention-days: 30

      - name: Upload Video Recordings
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: video-recordings-${{ matrix.browser }}-${{ matrix.test-suite }}
          path: test-output/videos/
          retention-days: 7

      - name: Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results (${{ matrix.browser }}-${{ matrix.test-suite }})
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false

  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      - name: Run Security Scan
        run: |
          mvn clean compile
          # Add OWASP dependency check or other security tools
          echo "Security scan completed"

  deploy-reports:
    runs-on: ubuntu-latest
    needs: test
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Test Artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts/

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: artifacts/test-results-chrome-web/target/allure-report
          destination_dir: reports

      - name: Send Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#automation"
          fields: repo,message,commit,author,action,eventName,ref,workflow
          env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        # Ensure that the secret 'SLACK_WEBHOOK' is defined in your repository settings under Settings > Secrets and variables > Actions > Repository secrets.
