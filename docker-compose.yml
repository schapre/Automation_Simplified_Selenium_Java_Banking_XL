version: '3.8'

services:
  # Selenium Hub for parallel execution
  selenium-hub:
    image: selenium/hub:4.15.0
    container_name: selenium-hub
    ports:
      - "4444:4444"
    environment:
      - GRID_MAX_SESSION=16
      - GRID_BROWSER_TIMEOUT=300
      - GRID_TIMEOUT=300
    networks:
      - automation-network

  # Chrome Node
  chrome-node:
    image: selenium/node-chrome:4.15.0
    container_name: selenium-chrome
    depends_on:
      - selenium-hub
    environment:
      - HUB_HOST=selenium-hub
      - HUB_PORT=4444
      - NODE_MAX_INSTANCES=4
      - NODE_MAX_SESSION=4
    volumes:
      - /dev/shm:/dev/shm
    networks:
      - automation-network
    deploy:
      replicas: 2

  # Firefox Node
  firefox-node:
    image: selenium/node-firefox:4.15.0
    container_name: selenium-firefox
    depends_on:
      - selenium-hub
    environment:
      - HUB_HOST=selenium-hub
      - HUB_PORT=4444
      - NODE_MAX_INSTANCES=4
      - NODE_MAX_SESSION=4
    volumes:
      - /dev/shm:/dev/shm
    networks:
      - automation-network
    deploy:
      replicas: 2

  # Automation Framework
  automation-tests:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: automation-framework
    depends_on:
      - selenium-hub
      - chrome-node
      - firefox-node
    environment:
      - BROWSER=${BROWSER:-chrome}
      - TEST_SUITE=${TEST_SUITE:-all}
      - HEADLESS=true
      - VIDEO_RECORDING=${VIDEO_RECORDING:-true}
      - SELENIUM_HUB_URL=http://selenium-hub:4444/wd/hub
      - PARALLEL_EXECUTION=true
    volumes:
      - ./test-output:/app/test-output
      - ./target:/app/target
      - ./logs:/app/logs
    networks:
      - automation-network
    command: >
      sh -c "
        echo 'üêã Waiting for Selenium Grid to be ready...'
        while ! curl -f http://selenium-hub:4444/wd/hub/status; do
          sleep 2
        done
        echo '‚úÖ Selenium Grid is ready!'
        /app/entrypoint.sh
      "

  # Test Report Server (Nginx to serve reports)
  report-server:
    image: nginx:alpine
    container_name: report-server
    ports:
      - "8080:80"
    volumes:
      - ./target/allure-report:/usr/share/nginx/html/allure:ro
      - ./test-output/SparkReport:/usr/share/nginx/html/spark:ro
      - ./test-output/HtmlReport:/usr/share/nginx/html/extent:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - automation-network

  # Database for test results (Optional)
  test-db:
    image: postgres:13
    container_name: test-database
    environment:
      - POSTGRES_DB=test_results
      - POSTGRES_USER=testuser
      - POSTGRES_PASSWORD=testpass123
    ports:
      - "5432:5432"
    volumes:
      - test_db_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - automation-network

  # Monitoring with Grafana (Optional)
  grafana:
    image: grafana/grafana:latest
    container_name: test-monitoring
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - automation-network

networks:
  automation-network:
    driver: bridge

volumes:
  test_db_data:
  grafana_data: